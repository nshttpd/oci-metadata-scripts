box: golang:1.12
build:
  steps:
    - wercker/golint@1.4.1:
        exclude: vendor
    - script:
        name: go test
        code: |
          go test -mod vendor ./...
    - script:
        name: go build
        code: |
          pwd
          go build -mod vendor -o oci-metadata-scripts .
          ls
package:
  box: nshttpd/fpm-packager:0a62ec4
  steps:
    - script:
        name: make directories
        code: |
          mkdir -p pkg/usr/bin
          mkdir -p pkg/etc/systemd/system
          mkdir -p pkg/var/lib/oci/scripts
    - script:
        name: copy files
        code: |
          pwd
          ls
          cp build/oci-metadata-scripts pkg/usr/bin/
          cp misc/*.service pkg/etc/systemd/system/
          cp misc/postinst.sh pkg/var/lib/oci/scripts/
          chmod 744 pkg/var/lib/oci/scripts/postinst.sh
    - script:
        name: fpm rpm builder
        code: |
          export VERSION=`cat VERSION`
          fpm -s dir -t rpm -v ${VERSION} -n oci-metadata-scripts -p pkg/build \
                      -C pkg/build --replaces oci-metadata-scripts --after-install /var/lib/oci/scripts/postinst.sh var/ usr/ etc/
          fpm -s dir -t deb -v ${VERSION} -n oci-metadata-scripts -p pkg/build \
                      -C pkg/build --replaces oci-metadata-scripts --after-install /var/lib/oci/scripts/postinst.sh var/ usr/ etc/
#deploy:
#  steps:
#    - script:
#        name: install ghr
#        code: |
#          go get github.com/tcnksm/ghr
#    - tcnksm/ghr:
#        name: run ghr
#        code: |
#          export VERSION=`cat VERSION`
#          ghr -delete ${VERSION} package/pkg/build/
#token: $GITHUB_TOKEN
#  input: $WERCKER_SOURCE_DIR/dist
#  version: latest
#  replace: true